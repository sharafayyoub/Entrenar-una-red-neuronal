<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reconocimiento de D√≠gitos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <h1>Reconocimiento de D√≠gitos</h1>
    <canvas id="canvas" width="280" height="280"></canvas>
    <br>
    <button id="clearBtn">Limpiar</button>
    <button id="predictBtn">Predecir</button>
    <p id="result"></p>

    <!-- ‚úÖ Bot√≥n para guardar el resultado -->
    <button id="saveBtn">Guardar en Firebase</button>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function initCanvas() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 15;
            ctx.lineCap = 'round';
        }
        initCanvas();

        let drawing = false;
        canvas.addEventListener('mousedown', e => drawing = true);
        canvas.addEventListener('mouseup', e => { drawing = false; ctx.beginPath(); autoPredict(); });
        canvas.addEventListener('mouseout', e => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);

        function draw(e) {
            if (!drawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        document.getElementById('clearBtn').addEventListener('click', () => {
            initCanvas();
            document.getElementById('result').innerText = "";
        });

        // üîÆ Funci√≥n de predicci√≥n
        async function predictDigit() {
            try {
                const dataURL = canvas.toDataURL('image/png');
                console.log("üì§ Enviando imagen al servidor...");
                const resp = await fetch('/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image: dataURL})
                });
                const json = await resp.json();
                console.log("üì• Respuesta del servidor:", json);
                if (json.error) {
                    document.getElementById('result').innerText = "Error: " + json.error;
                } else {
                    document.getElementById('result').innerText =
                        `Predicci√≥n: ${json.digit} (Confianza: ${json.confidence}%)`;

                    // ‚úÖ Guardar autom√°ticamente la predicci√≥n para Firebase
                    window.ultimaPrediccion = json; // guardamos para el bot√≥n
                }
            } catch (err) {
                console.error("Fetch error:", err);
                document.getElementById('result').innerText = "Error de red: " + err;
            }
        }

        document.getElementById('predictBtn').addEventListener('click', predictDigit);

        function autoPredict() {
            setTimeout(() => { predictDigit(); }, 300);
        }

        // ‚úÖ Guardar en Firebase (desde tu backend Flask)
        async function guardarEnFirebase() {
            if (!window.ultimaPrediccion) {
                alert("Primero haz una predicci√≥n antes de guardar.");
                return;
            }

            const { digit, confidence } = window.ultimaPrediccion;
            const data = {
                resultado: digit,
                confianza: confidence,
                timestamp: new Date().toISOString()
            };

            try {
                const resp = await fetch("/save", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });
                const json = await resp.json();
                console.log("‚úÖ Respuesta del servidor:", json);
                alert("Datos guardados en Firebase correctamente ‚úÖ");
            } catch (err) {
                console.error("Error al guardar en Firebase:", err);
                alert("Error al guardar en Firebase ‚ùå");
            }
        }

        // Asignar evento al bot√≥n de guardar
        document.getElementById('saveBtn').addEventListener('click', guardarEnFirebase);
    </script>
</body>
</html>

